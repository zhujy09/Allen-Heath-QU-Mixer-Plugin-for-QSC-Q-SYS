-- Basic Framework Plugin
-- by QSC
-- October 2020

-- Information block for the plugin
PluginInfo = {
  Name = "Allen & Heath~Qu Mixer",
  Version = "1.0",
  BuildVersion = "1.0.0.142",
  Id = "5b589c6d-5137-492a-a163-2bbfd2f949d4",
  Author = "Johnny Zhu",
  Description = "It is an one-way communication plugin of controlling a Allen&Heath QU mixer."  
}

-- Define the color of the plugin object in the design
function GetColor(props)
  return { 0, 50, 200 }
end

-- The name that will initially display when dragged into a design
function GetPrettyName(props)
  return "Allen & Heath~QU Mixer, version " .. PluginInfo.Version
end

-- Optional function used if plugin has multiple pages
PageNames = { "Setup", "Control" }  --List the pages within the plugin
function GetPages(props)
  local pages = {}
  for ix,name in ipairs(PageNames) do
    table.insert(pages, {name = PageNames[ix]})
  end
  return pages
end

-- Optional function to define model if plugin supports more than one model
function GetModel(props)
  local model = {}
  if props.Model ~= nil and props.Model.Value ~= "" then
    table.insert(model, { props.Model.Value } )
  else
    table.insert(model, { "Base Model" } )
  end
 return model
end

-- Define User configurable Properties of the plugin
function GetProperties()
  local props = {}
  table.insert(props, {
    Name = "Debug Print",
    Type = "enum",
    Choices = {"None", "Tx/Rx", "Tx", "Rx", "Function Calls", "All"},
    Value = "None"
  })
  table.insert(props, {
    Name = "Model", 
    Type = "enum", 
    --Choices = {"Qu-16", "Qu-24", "Qu-32", "Qu-SB", "Qu-Pac"}, Value = "Qu-32"
    Choices = {"Qu-32", "Other"}, Value = "Qu-32"
  })
  return props
end

-- Optional function to define pins on the plugin that are not connected to a Control
function GetPins(props)
  local pins = {}
  --[[ table.insert(pins,{
    Name = "Audio Output",
    Direction = "output",
  }) ]]
  return pins
end

-- Optional function to update available properties when properties are altered by the user
function RectifyProperties(props)
  if props.plugin_show_debug.Value == false then 
    props["Debug Print"].IsHidden = true 
  end
  return props
end

-- Optional function to define components used within the plugin
function GetComponents(props)
  local components = {}
  table.insert(components,{
    Name = "main_mixer",
    Type = "mixer",
    Properties =   
    {
      ["n_inputs"] = 8,
      ["n_outputs"] = 1,
    }
  })
  return components
end

-- Optional function to define wiring of components used within the plugin
function GetWiring(props)
  local wiring = {}
  -- table.insert( wiring, { "Audio Output", "main_mixer Output 1" } )
  return wiring
end

-- Defines the Controls used within the plugin
function GetControls(props)
  local ctrls = {}
  table.insert(ctrls, {
    Name = "SceneButton",
    ControlType = "Button",
    ButtonType = "Momentary",
    Count = 25,
    --UserPin = true,
    --PinStyle = "Input",
    Icon = "<NONE>"
  })
  table.insert(ctrls, {
    Name = "SceneKnob",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Count = 1,
    Min = 1, 
    Max = 100,
    UserPin = true,
    PinStyle = "Both"
  })
  table.insert(ctrls, {
    Name = "InputMute",
    ControlType = "Button",
    ButtonType = "Toggle",
    Count = 35,
    --UserPin = true,
    --PinStyle = "Both",
    Icon = "<NONE>"
  })
  table.insert(ctrls, {
    Name = "InputFader",
    ControlType = "Knob",
    ButtonType = "Fader",
    Count = 35,
    Min = 0, 
    Max = 127,
    --UserPin = true,
    --PinStyle = "Both",
  })
  table.insert(ctrls, {
    Name = "OutputMute",
    ControlType = "Button",
    ButtonType = "Toggle",
    Count = 14,
    --UserPin = true,
    --PinStyle = "Both",
    Icon = "<NONE>"
  })
  table.insert(ctrls, {
    Name = "OutputFader",
    ControlType = "Knob",
    ButtonType = "Fader",
    Count = 35,
    Min = 0, 
    Max = 127,
    --UserPin = true,
    --PinStyle = "Both",
  })
  
  
  --**Controls on Page "Setup"
  table.insert(ctrls, {
    Name = "IP Address",
    ControlType = "Text",
    Count = 1,
    DefaultValue = "127.0.0.1"
  })
  table.insert(ctrls, {
    Name = "Port",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Count = 1,
    Min = 1, 
    Max = 65535,
    DefaultValue = 51325
  })
  table.insert(ctrls, {
    Name = "Status",
    ControlType = "Indicator", 
    IndicatorType = "Status",
    Count = 1,
    UserPin = true,
    PinStyle = "Output"
  })
  table.insert(ctrls, {
    Name = "MIDI Channel",
    ControlType = "Knob",
    ControlUnit = "Integer",
    Count = 1,
    Min = 1, 
    Max = 16,
    DefaultValue = 1
  })
  return ctrls
end

--Layout of controls and graphics for the plugin UI to display
function GetControlLayout(props)
  local layout = {}
  local graphics = {}
  local CurrentPage = PageNames[props["page_index"].Value]
  --*** Page "Control" ********************************************************************************************* 
  if CurrentPage == "Control" then
    table.insert(graphics,{
      Type = "GroupBox",
      Text = "Control",
      TextSize = 15,
      Fill = {118,178,219},
      StrokeWidth = 1,
      Position = {0,0},
      Size = {1280,720}
    })
    table.insert(graphics,{
      Type = "Header",
      Text = "Scene Recall",
      TextSize = 12,
      Fill = {50,50,50},
      StrokeWidth = 1,
      Position = {10,30},
      Size = {1260,15}
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Button",
      TextSize = 12,
      Position = {10,80},
      Size = {60,24},
      FontSize = 11,
      HTextAlign = "Right"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Combo Box",
      Position = {10,154},
      Size = {60,24},
      TextSize = 12,
      HTextAlign = "Right"
    })
    --Scene Buttons
    for sceneIdx = 1, 25 do
      layout["SceneButton "..sceneIdx] = {
        PrettyName = "Buttons~Recall Scene ",
        Style = "Button",
        Position = {75 + 48*(sceneIdx-1), 80},
        TextSize = 12,
        Size = {48,24},
        Color = {255,255,255},
        Legend = tostring(sceneIdx)
      }
    end
    --Scene Knob
    layout["SceneKnob"] = {
      PrettyName = "Knob~Recall Scene ",
      Style = "ComboBox",
      Position = {75, 154},
      Size = {60,24},
      Color = {110,198,241},
      TextSize = 12,
    }
    --Connection Status Led Indicator
    layout["Status"] = {
      Style = "Led", 
      PrettyName = "Device~Connection Status", 
      Position = {2, 2}, 
      Size = {16, 16},
      Margin = 2,
      TextSize = 12,
  
    }
    table.insert(graphics,{
      Type = "Header",
      Text = "Inputs",
      TextSize = 12,
      Fill = {50,50,50},
      StrokeWidth = 1,
      Position = {10,210},
      Size = {1260,15}
    })
    
    table.insert(graphics,{
      Type = "Header",
      Text = "Outputs",
      TextSize = 12,
      Fill = {50,50,50},
      StrokeWidth = 1,
      Position = {10,480},
      Size = {1260,15}
    })
    --Input Labels
    for channelIdx = 1, 32 do
      table.insert(graphics,{
        Type = "Text",
        Text = tostring(channelIdx),
        TextSize = 12,
        Position = {10 + 36*(channelIdx-1), 234},
        Size = {36,36},
        FontSize = 11,
        HTextAlign = "Middle"
      })
    end 
    for channelIdx = 1, 3 do
      table.insert(graphics,{
        Type = "Text",
        Text = "ST"..tostring(channelIdx),
        TextSize = 12,
        Position = {1162 + 36*(channelIdx-1), 234},
        Size = {36,36},
        FontSize = 11,
        HTextAlign = "Middle"
      })
    end 
    --Output Labels
    for channelIdx = 1, 4 do
      table.insert(graphics,{
        Type = "Text",
        Text = tostring(channelIdx),
        TextSize = 12,
        Position = {10 + 36*(channelIdx-1), 504},
        Size = {36,36},
        FontSize = 11,
        HTextAlign = "Middle"
      })
    end 
    table.insert(graphics,{
      Type = "Text",
      Text = "5-6",
      TextSize = 12,
      Position = {154, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "7-8",
      TextSize = 12,
      Position = {190, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "9-10",
      TextSize = 12,
      Position = {226, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "LR",
      TextSize = 12,
      Position = {262, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Grp 1-2",
      TextSize = 12,
      Position = {298, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
     
    table.insert(graphics,{
      Type = "Text",
      Text = "Grp 3-4",
      TextSize = 12,
      Position = {334, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Grp 5-6",
      TextSize = 12,
      Position = {370, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Grp 7-8",
      TextSize = 12,
      Position = {406, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "MTX 1-2",
      TextSize = 12,
      Position = {442, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "MTX 3-4",
      TextSize = 12,
      Position = {478, 504},
      Size = {36,36},
      FontSize = 11,
      HTextAlign = "Middle"
    })
    -- InputMute Buttons
    for channelIdx = 1, 35 do
      layout["InputMute "..channelIdx] = {
        PrettyName = "Buttons~Input Mute ",
        Style = "Button",
        Position = {10 + 36*(channelIdx-1), 270},
        TextSize = 12,
        Size = {36,16},
        Color = {255,0,0},
        --Legend = tostring(sceneIdx)
      }
    end
    -- InputMute Faders
    for channelIdx = 1, 35 do
      layout["InputFader "..channelIdx] = {
        PrettyName = "Fader~Input Fader ",
        Style = "Fader",
        Position = {10 + 36*(channelIdx-1), 297},
        TextSize = 12,
        Size = {36,128},
      }
    end
    -- OutputMute Buttons
    for channelIdx = 1, 14 do
      layout["OutputMute "..channelIdx] = {
        PrettyName = "Buttons~Output Mute ",
        Style = "Button",
        Position = {10 + 36*(channelIdx-1), 540},
        TextSize = 12,
        Size = {36,16},
        Color = {255,0,0},
      }
    end
    -- OutputMute Faders
    for channelIdx = 1, 14 do
      layout["OutputFader "..channelIdx] = {
        PrettyName = "Fader~Output Fader ",
        Style = "Fader",
        Position = {10 + 36*(channelIdx-1), 567},
        TextSize = 12,
        Size = {36,128},
      }
    end
  
    --*** Page "Setup" ********************************************************************************************* 
  elseif CurrentPage == "Setup" then
    table.insert(graphics,{
      Type = "GroupBox",
      Text = "Setup",
      TextSize = 15,
      Fill = {118,178,219},
      StrokeWidth = 1,
      Position = {0,0},
      Size = {350,250}
    })
    --Show AH logo
    local AHLogo = "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UmVhZHlxyWU8AAAEAGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InV1aWQ6NUQyMDg5MjQ5M0JGREIxMTkxNEE4NTkwRDMxNTA4QzgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QUIyQ0VBRTY1NUU4MTFFOTk1Q0I4NTMzNkI3NTUzMDgiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QUIyQ0VBRTU1NUU4MTFFOTk1Q0I4NTMzNkI3NTUzMDgiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzlmOTBjMWQtOGE5Mi1iZTRjLTlmODktZjliODJmZDMzNDM5IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOmRhZGIzMzFjLTk3Y2QtYWQ0ZS1iMDk5LWI1NjI5ZDNlYjMxNSIvPiA8ZGM6dGl0bGU+IDxyZGY6QWx0PiA8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"
    table.insert(graphics,{
      Type="Image",
      Image=AHLogo,
      Position={205,220},
      Size={141,30}
    })
    --Show Qu logo
    local QuLogo = "iVBORw0KGgoAAAANSUhEUgAAAR0AAACmCAYAAADnEFt5AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJBNzMxOEMxMDFENTExRUNCMDMwOEIzRjlCQUZCMEI3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJBNzMxOEMyMDFENTExRUNCMDMwOEIzRjlCQUZCMEI3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkE3MzE4QkYwMUQ1MTFFQ0IwMzA4QjNGOUJBRkIwQjciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkE3MzE4QzAwMUQ1MTFFQ0IwMzA4QjNGOUJBRkIwQjciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5xTE9sAAAOG0lEQVR42uydC5Rd0xnH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"
    table.insert(graphics,{
      Type="Image",
      Image=QuLogo,
      Position={228,0},
      Size={115,67}
    })
  
    table.insert(graphics,{
      Type = "Header",
      Text = "Setup",
      TextSize = 12,
      Fill = {50,50,50},
      StrokeWidth = 1,
      Position = {10,30},
      Size = {205,15}
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "IP Address",
      TextSize = 12,
      Position = {12,80},
      Size = {72,24},
      HTextAlign = "Right"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Port: 51325 ",
      TextSize = 12,
      Position = {12,104},
      Size = {72,24},
      HTextAlign = "Right"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "Status",
      TextSize = 12,
      Position = {12,140},
      Size = {72,24},
      HTextAlign = "Right"
    })
    table.insert(graphics,{
      Type = "Text",
      Text = "MIDI Channel",
      TextSize = 12,
      Position = {12,176},
      Size = {72,24},
      HTextAlign = "Right"
    })
    layout["IP Address"] = {
      PrettyName = "Mixer's IP Address",
      Style = "TextField",
      Position = {84, 80},
      Size = {106,24},
      Color = {255,255,255},
      TextSize = 12,
    }
  --[[   layout["Port"] = {
      PrettyName = "Fixed at 51325",
      Style = "TextField",
      Position = {84, 105},
      Size = {106,24},
      Color = {110,198,241},
      TextSize = 12,
    }
   ]]
    layout["Status"] = {
      PrettyName = "Connection Status",
      Style = "Status",
      Position = {84, 138},
      Size = {230,24}
      --Color = {194,194,194},
      --IsReadOnly = true
    }
    layout["MIDI Channel"] = {
      PrettyName = "MIDI Channel (Setup on Mixer)",
      Style = "ComboBox",
      Position = {84, 176},
      Size = {60,24},
      Color = {110,198,241},
      TextSize = 12,
    }
  end
  return layout, graphics
end

--Start event based logic
if Controls then
  --Johnny Zhu
  --jianyezhu@qq.com
  --2021.08.30
  --------------------------------------------------------------------
  -- UI variables
  --------------------------------------------------------------------
  -- controls
  --btn_enable = Controls["Enable"]
  knob_midichannel = Controls["MIDI Channel"]
  
  btn_scene = Controls["SceneButton"]
  knob_scene = Controls["SceneKnob"]
  -- btn_scene = Controls.SceneButton
  -- knob_scene = Controls.SceneKnob
  
  btn_inputmute = Controls["InputMute"]
  fader_inputfader = Controls["InputFader"]
  btn_outputmute = Controls["OutputMute"]
  fader_outputfader = Controls["OutputFader"]
  
  --Connection Status
  stat_details = Controls["Status"]
  --[[ Status.Value:
  5-Initializing-blue	
  4-Missing	-#C00000	
  3-Not Present-gray	
  2-Fault-red	
  1-Compromised-orange	
  0-OK-green	
  ]]--
  
  -- TCP/UCP connection
  txt_address = Controls["IP Address"]
  knb_port = Controls["Port"]
  knb_port.Value = 51325
  
  
  --------------------------------------------------------------------
  -- Other variables and CONSTANTS
  --------------------------------------------------------------------
  --Global Variables
  tx = ""
  midiChannel = knob_midichannel.Value -1 
  
  --CONSTANTS
  --STX = "\x02"
  ETX = ""
  --ETX = "\x0D\x0A"
  
  -- commands to device
  
  --------------------------------------------------------------------
  -- Function Definition
  --------------------------------------------------------------------
  function DebugFormatHex(string,hex) -- Format strings containing non-printable characters so we can see what they are
    local visual = ""
    local format = hex~=nil and "\\x%02x" or "[%02X]" --hex==nil: format="[%02X]";  hex~=nil: format="\\x%02x"
    for i=1,#string do
      local byte = string:sub(i,i)
      visual = visual..string.format(format,string.byte(byte))
    end
    return visual
  end
  
  --------------------------------------------------------------------
  -- Socket Connection
  --------------------------------------------------------------------
  -- socket
  sock = TcpSocket.New()
  sock.ReadTimeout = 0
  sock.WriteTimeout = 0
  sock.ReconnectTimeout = 5
  sock:Connect(txt_address.String, knb_port.Value)
  
  -- send data
  function send(data)
    --print("sending: "..data)
    tx = data
    sock:Connect(txt_address.String, knb_port.Value)
  end
  
  -- report connection details to gui
  function connStat(message, severity)
    stat_details.Value = severity
    stat_details.String = message
    
    if severity == 2 then
      Log.Error(string.format("%s:%s\t%s", txt_address.String, knb_port.String, message))
    end
  end
  
  -- do when event is data
  function parseResponse()
    
    rx = sock:Read(sock.BufferLength)
    
    if rx ~= nil then
      print("received: "..DebugFormatHex(rx))
      stat_details.String = "RX: "..DebugFormatHex(rx)
      -- do something with data here
    end
    
    --sock:Disconnect()
    --connStat("socket closed by client", 1)
  end
      
  sock.EventHandler = function(sock, evt, err)
    if evt == TcpSocket.Events.Connected then -- Connected
      connStat("TX: "..DebugFormatHex(tx), 0)
      sock:Write(tx)
      print("sending: "..DebugFormatHex(tx) )
  
    elseif evt == TcpSocket.Events.Reconnect then -- Reconnecting
      connStat("socket reconnecting...", 5)
    elseif evt == TcpSocket.Events.Data then  -- Data
      connStat("data received from remote", 0)
      parseResponse()   
    elseif evt == TcpSocket.Events.Closed then  -- Closed by remote
      connStat("socket closed by remote", 4)
    elseif evt == TcpSocket.Events.Error then -- Error
      connStat("socket closed due to error", 2)
    elseif evt == TcpSocket.Events.Timeout then -- Timeout
      connStat("socket closed due to timeout", 3)
    end  
  end
  
  --------------------------------------------------------------------
  -- Event Handlers
  --------------------------------------------------------------------
  
  --btn_enable.EventHandler = function()
    --send(enable) 
    --end
  knob_midichannel.EventHandler = function()
    midiChannel = knob_midichannel.Value -1 
    print("MIDI Channel = "..string.format("0x%02X", midiChannel) )
    end
  
  --[[
  for i=1, #btn_scene do
    btn_scene[i].EventHandler = function()
      send(scene[i])
    end
  end
  ]]--  
  for i=1, #btn_scene do
    btn_scene[i].EventHandler = function()
      if btn_scene[i].Boolean == true then
        tx = string.format("%c", 0xB0 + midiChannel).."\x00\x00"..string.format("%c", 0xB0 + midiChannel).."\x20\x00"..string.format("%c", 0xC0 + midiChannel)..string.format("%c", i-1)..ETX
        send(tx)
      end
    end
  end
  
  knob_scene.EventHandler = function()
    tx = string.format("%c", 0xB0 + midiChannel).."\x00\x00"..string.format("%c", 0xB0 + midiChannel).."\x20\x00"..string.format("%c", 0xC0 + midiChannel)..string.format("%c", knob_scene.Value -1)..ETX
    send(tx)
    end
    
  --Mute on   9N, CH, 7F,     8N, CH, 00
  --Mute off  9N, CH, 3F,     8N, CH, 00 
  for i=1, #btn_inputmute do
    btn_inputmute[i].EventHandler = function()
        if btn_inputmute[i].Boolean == true then  --on
          tx = string.format("%c", 0x90 + midiChannel)..string.format("%c", 0x1F + i).."\x7F"..string.format("%c", 0x80 + midiChannel)..string.format("%c", 0x1F + i).."\x00"..ETX
        else
          tx = string.format("%c", 0x90 + midiChannel)..string.format("%c", 0x1F + i).."\x3F"..string.format("%c", 0x80 + midiChannel)..string.format("%c", 0x1F + i).."\x00"..ETX
        end
      send(tx)
    end
  end
  
  for i=1, #btn_outputmute do
    btn_outputmute[i].EventHandler = function()
        if btn_outputmute[i].Boolean == true then  --on
          tx = string.format("%c", 0x90 + midiChannel)..string.format("%c", 0x5F + i).."\x7F"..string.format("%c", 0x80 + midiChannel)..string.format("%c", 0x5F + i).."\x00"..ETX
        else
          tx = string.format("%c", 0x90 + midiChannel)..string.format("%c", 0x5F + i).."\x3F"..string.format("%c", 0x80 + midiChannel)..string.format("%c", 0x5F + i).."\x00"..ETX
        end
      send(tx)
    end
  end
  
  --Fader     BN, 63, CH, BN, 62, 17, BN, 06, VA BN, 26, 07 
  for i=1, #fader_inputfader do
    fader_inputfader[i].EventHandler = function()
      tx = string.format("%c", 0xB0 + midiChannel).."\x63"..string.format("%c", 0x1F + i)..string.format("%c", 0xB0 + midiChannel).."\x62\x17"..string.format("%c", 0xB0 + midiChannel).."\x06"..string.format("%c", fader_inputfader[i].Value)..string.format("%c", 0xB0 + midiChannel).."\x26\x07"..ETX
      send(tx)
    end
  end
  
  for i=1, #fader_outputfader do
    fader_outputfader[i].EventHandler = function()
      tx = string.format("%c", 0xB0 + midiChannel).."\x63"..string.format("%c", 0x5F + i)..string.format("%c", 0xB0 + midiChannel).."\x62\x17"..string.format("%c", 0xB0 + midiChannel).."\x06"..string.format("%c", fader_outputfader[i].Value)..string.format("%c", 0xB0 + midiChannel).."\x26\x07"..ETX
      send(tx)
    end
  end
  
end
